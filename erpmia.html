<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cierre de Caja</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f4f6f8; --panel:#ffffff; --muted:#5e6973; --primary:#2f4753; --primary-strong:#1f333c;
  --income:#e9f4ee; --expense:#f9ecec; --glass:rgba(47,71,83,0.10); --soft-line:rgba(0,0,0,0.06);
  --chip:#e9eef3; --ink:#1e2a31; --btn-ing:#2f7a4f; --btn-egr:#b14b4b; --btn-neutral:#2f4753;
  --ctl-esperado:#d9efe4; --ctl-contado:#e6eef6; --ctl-dif:#f6e9d9;
}
*{box-sizing:border-box}
body{margin:0;font-family:Calibri,Arial,sans-serif;background:var(--bg);color:var(--ink);font-size:15px}
.header{max-width:1040px;margin:18px auto 8px;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:0 12px}
.header-title{font-family:'Montserrat',sans-serif;font-weight:800;letter-spacing:.5px;line-height:2;color:#223440;font-size:32px;text-transform:uppercase}
.date-bar{display:flex;align-items:center;gap:10px}
.date-big{font-family:'Montserrat',sans-serif;font-weight:700;color:var(--primary-strong);font-size:28px;letter-spacing:.2px;min-width:170px;text-align:right}
.nav-btn,.cal-btn{border:1px solid var(--glass);background:#eef2f6;border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:800;font-size:16px;transition:.15s transform,.15s filter;color:#233642}
.cal-btn{font-weight:700;font-size:20px;line-height:1;padding:8px 10px}
.nav-btn:hover,.cal-btn:hover{transform:translateY(-1px);filter:brightness(.97)}
.nav-btn[disabled],.cal-btn[disabled]{opacity:.5;cursor:not-allowed}
#datePicker{position:absolute;opacity:0;pointer-events:none;height:0;width:0}
.container{max-width:1040px;margin:0 auto 24px;padding:12px}
.card{background:var(--panel);border-radius:12px;padding:14px;border:1px solid var(--glass)}
.tabs{display:flex;gap:10px;margin:6px 0 12px}
.tab{flex:1;padding:10px;border-radius:10px;text-align:center;font-weight:700;color:var(--muted);cursor:pointer;background:#eef2f5;border:1px solid rgba(36,50,59,0.08)}
.tab.active{background:#2f4753;color:#fff}
.table-wrap{overflow:auto;border-radius:10px;margin-top:4px}
table{width:100%;border-collapse:separate;border-spacing:0 6px}
thead th{padding:8px 10px;text-align:left;color:var(--muted);font-weight:800;font-size:13px}
tbody td{padding:8px 10px;font-size:14px;border-top:1px solid var(--soft-line);border-bottom:1px solid var(--soft-line);vertical-align:middle}
tr.row-income td{background:var(--income)}
tr.row-expense td{background:var(--expense)}
tbody tr td:first-child{border-left:1px solid var(--soft-line);border-top-left-radius:10px;border-bottom-left-radius:10px}
tbody tr td:last-child{border-right:1px solid var(--soft-line);border-top-right-radius:10px;border-bottom-right-radius:10px}
.drag-handle{cursor:grab}
.actions-td{position:relative;width:60px}
.menu-wrap{position:relative;display:inline-block}
.menu-trigger{border:none;background:transparent;cursor:pointer;font-size:20px;line-height:1;padding:6px 8px;border-radius:8px}
.menu-trigger:hover{background:rgba(0,0,0,.06)}
.menu{position:absolute;right:0;top:36px;min-width:140px;background:#fff;border:1px solid rgba(0,0,0,.1);border-radius:10px;box-shadow:0 10px 20px rgba(0,0,0,.12);display:none;z-index:5;overflow:hidden}
.menu.show{display:block}
.menu button{width:100%;text-align:left;border:none;background:#fff;padding:10px 12px;cursor:pointer;font-size:14px}
.menu button:hover{background:#f2f6f9}
.menu .danger{color:#9c3a3a}
.arqueo-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:820px){.arqueo-grid{grid-template-columns:1fr}}
.tile{background:linear-gradient(180deg,#ffffff 0%,#fbfcfd 100%);padding:14px;border-radius:14px;border:1px solid var(--glass);box-shadow:0 6px 18px rgba(0,0,0,.05)}
.tile-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.tile-title{font-size:13px;font-weight:900;color:#2a3b45;letter-spacing:.2px}
.chip{background:var(--chip);border:1px solid var(--glass);border-radius:999px;padding:6px 10px;font-weight:800;color:#2b3a42;font-size:12px}
.list{margin:0;padding:0;list-style:none;max-height:260px;overflow:auto;border-top:1px dashed rgba(0,0,0,0.08)}
.item{display:grid;grid-template-columns:1fr auto;gap:8px;padding:8px 0;border-bottom:1px dashed rgba(0,0,0,0.06);font-size:14px;align-items:center}
.item .concepto{color:#21333b;font-weight:600}
.item .monto{font-weight:800;text-align:right}
.totals{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:14px}
.ctl{padding:16px;border-radius:14px;border:1px solid var(--glass);box-shadow:0 4px 12px rgba(0,0,0,.04)}
.ctl-esperado{background:var(--ctl-esperado)} .ctl-contado{background:var(--ctl-contado)} .ctl-dif{background:var(--ctl-dif)}
.ctl .label{font-size:12px;color:#20323a;font-weight:900;letter-spacing:.2px}
.ctl .val{font-weight:900;margin-top:8px;color:#1f2f35;font-size:20px}
.ctl input{width:130px;margin-top:10px;padding:10px;border-radius:10px;border:1px solid rgba(36,50,59,0.18);background:#fff;font-size:15px}
@media(max-width:760px){.totals{grid-template-columns:1fr}}
input,select,textarea{padding:12px;border-radius:12px;border:1px solid rgba(36,50,59,0.15);font-size:14px;background:#f9fbfc;transition:border .15s,box-shadow .15s}
input:focus,select:focus,textarea:focus{outline:none;border-color:#7aa6be;box-shadow:0 0 0 3px rgba(122,166,190,.25)}
select{-webkit-appearance:none;-moz-appearance:none;appearance:none;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="%2332434d" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>');background-repeat:no-repeat;background-position:right 12px center;background-size:18px;padding-right:38px}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(10,15,13,.32);backdrop-filter:blur(4px);z-index:10}
.modal.open{display:flex}
.sheet{width:100%;max-width:820px;border-radius:20px;overflow:hidden;background:#fff;border:1px solid var(--glass);box-shadow:0 30px 80px rgba(17,33,31,.18)}
.sheet-head{padding:12px 16px;border-bottom:1px solid rgba(0,0,0,0.06);background:linear-gradient(135deg,#ecf2f6 0%,#ffffff 70%);display:flex;align-items:center;justify-content:space-between}
.sheet-title{font-weight:900;color:#1f2f39;font-size:18px;letter-spacing:.2px}
.close-x{border:none;background:#eef2f6;border:1px solid var(--glass);font-size:18px;cursor:pointer;padding:8px 10px;border-radius:10px}
.close-x:hover{filter:brightness(.97)}
.sheet-body{padding:16px}
.form-grid{display:flex;flex-direction:column;gap:12px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:700px){.form-row{grid-template-columns:1fr}}
.cell{display:flex;flex-direction:column}
.cell label{font-size:12px;color:#3e4a54;font-weight:800;margin-bottom:6px;letter-spacing:.2px}
textarea{min-height:96px;resize:vertical}
.sheet-actions{display:flex;justify-content:flex-end;gap:10px;padding:12px 16px;border-top:1px solid rgba(0,0,0,0.06);background:#fafcfd}
.btn{border:none;border-radius:12px;padding:12px 14px;cursor:pointer;font-weight:800;letter-spacing:.2px;box-shadow:0 6px 18px rgba(0,0,0,.09);transition:filter .15s,transform .15s}
.btn:disabled{opacity:.55;cursor:not-allowed}
.btn:hover{filter:brightness(.97);transform:translateY(-1px)}
.btn-primary{background:var(--btn-neutral);color:#fff}
.btn-ghost{background:#eef2f6;color:#1f2f39;border:1px solid var(--glass)}
.btn-add{background:#eaf5ee;color:#245b37;border:1px solid rgba(36,91,55,.25)}
.btn-del{background:#ffecec;color:#8a2b2b;border:1px solid rgba(138,43,43,.25)}
.paylines{border:1px dashed rgba(0,0,0,.15);border-radius:12px;padding:10px;background:#fcfefe}
.payline{display:grid;grid-template-columns:1fr 1fr auto;gap:10px;align-items:center;margin-top:8px}
.payline select,.payline input{width:100%}
.fab-wrap{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:10px;z-index:12}
.fab{width:56px;height:56px;border-radius:16px;display:flex;align-items:center;justify-content:center;border:1px solid var(--glass);box-shadow:0 10px 22px rgba(0,0,0,.18);cursor:pointer;font-size:22px;color:#fff;transition:transform .15s,filter .15s}
.fab-ing{background:var(--btn-ing)}
.fab-egr{background:var(--btn-egr)}
.fab:disabled{opacity:.55;cursor:not-allowed}
.fab:hover{filter:brightness(.96);transform:translateY(-1px)}
.suggest{position:absolute;left:0;right:0;top:100%;margin-top:6px;background:#fff;border:1px solid rgba(0,0,0,.12);border-radius:12px;box-shadow:0 14px 28px rgba(0,0,0,.12);z-index:20;overflow:hidden}
.suggest button{display:block;width:100%;padding:10px 12px;border:none;background:#fff{text-align:left;cursor:pointer}
.suggest button:hover{background:#f1f5f8}
</style>
</head>
<body>
<div class="header">
  <div class="header-title">MIA ESTÉTICA INTEGRAL</div>
  <div class="date-bar" id="date-bar-ui">
    <button id="prev-day" class="nav-btn" title="Día anterior">◀</button>
    <div class="date-big" id="hoy">-- ---</div>
    <button id="next-day" class="nav-btn" title="Día siguiente">▶</button>
    <button id="btn-cal" class="cal-btn" title="Seleccionar fecha">📅</button>
    <input id="datePicker" type="date" />
  </div>
</div>

<div class="container">
  <div class="card">
    <div class="tabs">
      <button id="tab-reg" class="tab active">MOVIMIENTOS</button>
      <button id="tab-arq" class="tab">ARQUEO</button>
      <button id="tab-busq" class="tab">BUSCADOR</button>
    </div>

    <div id="panel-reg">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th></th><th>FECHA</th><th>CLIENTE</th><th>CONCEPTO</th><th>DESCRIPCIÓN</th><th>MONTO</th><th>MEDIO</th><th></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div id="panel-arq" style="display:none">
      <div class="arqueo-grid">
        <div class="tile">
          <div class="tile-head"><div class="tile-title">INGRESOS EFECTIVO</div><div class="chip" id="sum-ing-efectivo">$0.00</div></div>
          <ul id="lista-ing-efectivo" class="list"></ul>
        </div>
        <div class="tile">
          <div class="tile-head"><div class="tile-title">EGRESOS EFECTIVO</div><div class="chip" id="sum-egr-efectivo">$0.00</div></div>
          <ul id="lista-egr-efectivo" class="list"></ul>
        </div>
      </div>
      <div class="totals">
        <div class="ctl ctl-esperado"><div class="label">ESPERADO EFECTIVO</div><div id="esperado" class="val">$0.00</div></div>
        <div class="ctl ctl-contado"><div class="label">EFECTIVO CONTADO</div><input id="contado" type="number" step="0.01" placeholder="0.00" /></div>
        <div class="ctl ctl-dif"><div class="label">DIFERENCIA</div><div id="diferencia" class="val">$0.00</div></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="btn-calcular" class="btn btn-primary">CALCULAR</button>
        <button id="btn-limpiar" class="btn btn-ghost">LIMPIAR</button>
      </div>
    </div>

    <div id="panel-busq" style="display:none">
      <div class="tile">
        <div class="tile-title" style="margin-bottom:6px;text-align:center">BUSCAR PAGOS POR CLIENTE</div>
        <div style="display:flex;justify-content:center;align-items:center;gap:10px;margin:8px 0 6px">
          <div style="position:relative;width:100%;max-width:720px">
            <input id="busq-cliente" placeholder="Escribí y seleccioná un cliente..." autocomplete="off" style="width:100%;padding:12px 52px 12px 12px;border:1px solid rgba(0,0,0,.15);border-radius:12px;background:#f9fbfc"/>
            <span style="position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:18px;opacity:.7">🔎</span>
            <div id="sug-busq" class="suggest" style="display:none"></div>
          </div>
          <button id="busq-limpiar" class="btn btn-ghost">LIMPIAR</button>
        </div>

        <div class="busq-table-wrap" id="busq-wrap" style="display:none">
          <table class="busq-table" style="width:100%;border-collapse:separate;border-spacing:0">
            <thead>
              <tr>
                <th style="width:90px;background:#f2f5f8;color:#30414b;padding:10px;font-weight:800;font-size:13px;text-align:left;border-bottom:1px solid rgba(0,0,0,0.08)">FECHA</th>
                <th style="background:#f2f5f8;color:#30414b;padding:10px;font-weight:800;font-size:13px;text-align:left;border-bottom:1px solid rgba(0,0,0,0.08)">CLIENTE</th>
                <th style="background:#f2f5f8;color:#30414b;padding:10px;font-weight:800;font-size:13px;text-align:left;border-bottom:1px solid rgba(0,0,0,0.08)">CONCEPTO</th>
                <th style="background:#f2f5f8;color:#30414b;padding:10px;font-weight:800;font-size:13px;text-align:left;border-bottom:1px solid rgba(0,0,0,0.08)">DESCRIPCIÓN</th>
                <th style="width:120px;text-align:right;background:#f2f5f8;color:#30414b;padding:10px;font-weight:800;font-size:13px;border-bottom:1px solid rgba(0,0,0,0.08)">MONTO</th>
                <th style="width:160px;background:#f2f5f8;color:#30414b;padding:10px;font-weight:800;font-size:13px;text-align:left;border-bottom:1px solid rgba(0,0,0,0.08)">MEDIO</th>
              </tr>
            </thead>
            <tbody id="busq-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<div class="fab-wrap" id="fabs">
  <button id="fab-ing" class="fab fab-ing" title="Agregar venta" aria-label="Agregar venta">＋</button>
  <button id="fab-egr" class="fab fab-egr" title="Agregar egreso" aria-label="Agregar egreso">−</button>
</div>

<div id="modal" class="modal" aria-hidden="true">
  <div class="sheet">
    <div class="sheet-head">
      <div id="modal-title" class="sheet-title">NUEVA VENTA</div>
      <button id="modal-cerrar" class="close-x" title="Cerrar" aria-label="Cerrar">✖</button>
    </div>
    <div class="sheet-body">
      <div class="form-grid">
        <div class="form-row" id="row-1">
          <div class="cell" id="wrap-cliente">
            <label>CLIENTE</label>
            <div style="position:relative">
              <input id="in-cliente" autocomplete="off" placeholder="Escribí para buscar o crear..." style="width:100%;padding-right:44px;" />
              <span id="icon-lupa" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:18px;opacity:.7;pointer-events:none">🔎</span>
              <div id="sug-clientes" class="suggest" style="display:none"></div>
            </div>
          </div>
          <div class="cell" id="wrap-concepto-select">
            <label>CONCEPTO</label>
            <select id="in-concepto-select">
              <option>FACIALES</option><option>CORPORALES</option><option>DEPILACION</option>
              <option>MASAJES</option><option>PELUQUERIA</option><option>PRODUCTOS</option><option>CURSOS</option>
            </select>
          </div>
        </div>

        <div class="form-row" id="row-desc-ing">
          <div class="cell" style="grid-column:1/-1">
            <label>DETALLE DEL SERVICIO</label>
            <textarea id="in-detalle-ing" placeholder="DETALLE DEL SERVICIO O NOTA INTERNA..."></textarea>
          </div>
        </div>

        <div class="form-row" id="row-paylines">
          <div class="cell" style="grid-column:1/-1">
            <label>FORMAS DE PAGO (PODÉS AGREGAR VARIAS)</label>
            <div class="paylines" id="paylines"></div>
            <div style="margin-top:10px;display:flex;gap:10px">
              <button type="button" id="btn-add-line" class="btn btn-add">+ AGREGAR LÍNEA</button>
            </div>
            <div class="small">Cada línea genera un registro independiente.</div>
          </div>
        </div>

        <div class="form-row" id="row-egreso">
          <div class="cell">
            <label>CONCEPTO EGRESO</label>
            <select id="in-concepto-eg">
              <option>CRÉDITOS</option>
              <option>INSUMOS</option>
              <option>MERCADERÍA</option>
              <option>SUELDOS</option>
              <option>SALIDA DE CAJA</option>
              <option>VARIOS</option>
            </select>
          </div>
          <div class="cell">
            <label>MEDIO</label>
            <select id="in-medio-eg"></select>
          </div>
          <div class="cell">
            <label>MONTO</label>
            <input id="in-monto-eg" type="number" step="0.01" />
          </div>
          <div class="cell" style="grid-column:1/-1">
            <label>DETALLE</label>
            <textarea id="in-desc-eg" placeholder="DETALLE DEL EGRESO..."></textarea>
          </div>
        </div>

      </div>
    </div>
    <div class="sheet-actions">
      <button id="guardar" class="btn btn-primary">GUARDAR</button>
      <button id="cancelar" class="btn btn-ghost">CANCELAR</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script>
/* ============ CONFIG: URL del Web App y TOKEN ============ */
const API_URL   = 'https://script.google.com/macros/s/AKfycbzIiFPdFMS81CTkxFqTBegvphQPI22KdRZkvyKj39n9WJMhUJAjl-dw4CTxZE2X8wBx-w/exec'; // ej: https://script.google.com/macros/s/XXX/exec
const API_TOKEN = 'AKfycbzIiFPdFMS81CTkxFqTBegvphQPI22KdRZkvyKj39n9WJMhUJAjl-dw4CTxZE2X8wBx-w';         // mismo que en Apps Script

/* ===== Helpers de fecha y UI ===== */
const ddmm = (d)=> String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0');
const dias = ['DOM','LUN','MAR','MIE','JUE','VIE','SAB'], meses=['ENE','FEB','MAR','ABR','MAY','JUN','JUL','AGO','SEP','OCT','NOV','DIC'];
const titleWithDay = (d)=> dias[d.getDay()]+' '+String(d.getDate()).padStart(2,'0')+' '+meses[d.getMonth()];
const toISO=(d)=> d.toISOString().slice(0,10);
const fromISOtoDate=(iso)=>{const [y,m,da]=iso.split('-').map(Number);return new Date(y,m-1,da);}
const el=id=>document.getElementById(id);
const money=n=> (n<0?'- ':'')+'$'+Math.abs(n).toFixed(2);

/* ===== Estados ===== */
const MEDIOS_INGRESO = ['EFECTIVO','HANDY DÉBITO','HANDY CUOTAS','MERCADOPAGO','TRANSFERENCIA'];
const MEDIOS_EGRESO  = ['EFECTIVO','TRANSFERENCIA','DEPÓSITO'];

let movimientos = []; // sincroniza con Sheets por fecha
let tipoActual='ingreso', editIndex=null;
const today=new Date(); const todayDDMM=ddmm(today);
let fechaSeleccionadaDate=new Date(today);

/* ===== API ===== */
async function apiListByDate(ddmmStr){
  const url = `${API_URL}?action=list&fecha=${encodeURIComponent(ddmmStr)}`;
  const r = await fetch(url, {method:'GET'});
  const j = await r.json();
  if(!j.ok) throw new Error(j.error||'Error list');
  return j.rows||[];
}
async function apiSearchCliente(nombreUpper){
  const url = `${API_URL}?action=search&cliente=${encodeURIComponent(nombreUpper)}`;
  const r = await fetch(url, {method:'GET'});
  const j = await r.json();
  if(!j.ok) throw new Error(j.error||'Error search');
  return j.rows||[];
}
async function apiAddRows(rows){
  const r = await fetch(API_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({token:API_TOKEN, action:'add', rows})
  });
  const j = await r.json();
  if(!j.ok) throw new Error(j.error||'Error add');
  return j.inserted||0;
}

/* ===== INIT UI ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  const hoySpan=el('hoy'), datePicker=el('datePicker'), prevBtn=el('prev-day'), nextBtn=el('next-day');
  hoySpan.textContent=titleWithDay(fechaSeleccionadaDate);
  datePicker.max=toISO(today); datePicker.value=toISO(fechaSeleccionadaDate);
  function updateNavButtons(){ nextBtn.disabled = toISO(fechaSeleccionadaDate)===toISO(today); }
  async function refreshDate(d){
    fechaSeleccionadaDate=new Date(d.getFullYear(),d.getMonth(),d.getDate());
    datePicker.value=toISO(fechaSeleccionadaDate); hoySpan.textContent=titleWithDay(fechaSeleccionadaDate);
    updateNavButtons();
    await syncFromSheet(); render(); actualizarArqueoVista();
  }
  prevBtn.addEventListener('click',()=>{const d=new Date(fechaSeleccionadaDate); d.setDate(d.getDate()-1); refreshDate(d);});
  nextBtn.addEventListener('click',()=>{if(nextBtn.disabled)return; const d=new Date(fechaSeleccionadaDate); d.setDate(d.getDate()+1); refreshDate(d);});
  el('btn-cal').addEventListener('click',()=> datePicker.showPicker ? datePicker.showPicker() : datePicker.click());
  datePicker.addEventListener('change',()=>{const d=fromISOtoDate(datePicker.value||toISO(today)); refreshDate(d);});
  updateNavButtons();

  const tabs={reg:el('panel-reg'),arq:el('panel-arq'),busq:el('panel-busq')};
  const tabBtns={reg:el('tab-reg'),arq:el('tab-arq'),busq:el('tab-busq')};
  function setActiveTab(name){
    Object.values(tabBtns).forEach(b=>b.classList.remove('active')); tabBtns[name].classList.add('active');
    Object.values(tabs).forEach(p=>p.style.display='none'); tabs[name].style.display='block';
    el('date-bar-ui').style.visibility = name==='reg'?'visible':'hidden';
    el('date-bar-ui').style.pointerEvents = name==='reg'?'auto':'none';
    if(name==='arq') actualizarArqueoVista(); if(name==='busq') clearBuscadorUI();
  }
  Object.entries(tabBtns).forEach(([k,btn])=> btn.addEventListener('click',()=>setActiveTab(k))); setActiveTab('reg');

  await syncFromSheet(); render(); actualizarArqueoVista();
});

/* ===== Sincronización ===== */
async function syncFromSheet(){
  const rows = await apiListByDate(ddmm(fechaSeleccionadaDate));
  movimientos = rows.map(r=>({
    fecha:r.fecha, cliente:r.cliente||'', concepto:r.concepto||'',
    descripcion:r.descripcion||'', monto:Number(r.monto)||0, medio:r.medio||'', tipo:r.tipo||''
  }));
}

/* ===== Modal y creación ===== */
const modal=el('modal'); const sugBox=el('sug-clientes');
const inCliente=el('in-cliente'); const inDetalleIng=el('in-detalle-ing');
const selConcepto=el('in-concepto-select'); const paylines=el('paylines'), btnAddLine=el('btn-add-line');
const selConceptoEg=el('in-concepto-eg'), selMedioEg=el('in-medio-eg'), montoEg=el('in-monto-eg'), inDescEg=el('in-desc-eg');
const fabIng=el('fab-ing'), fabEgr=el('fab-egr');

function toggleFabs(){ const esHoy = ddmm(fechaSeleccionadaDate)===ddmm(new Date()); fabIng.disabled=!esHoy; fabEgr.disabled=!esHoy; }
toggleFabs();

fabIng.addEventListener('click',()=>openModal('ingreso'));
fabEgr.addEventListener('click',()=>openModal('egreso'));

function addPayline(medio='EFECTIVO', monto=''){
  const wrap=document.createElement('div'); wrap.className='payline';
  wrap.innerHTML=`
    <select class="pl-medio">${MEDIOS_INGRESO.map(m=>`<option ${m===medio?'selected':''}>${m}</option>`).join('')}</select>
    <input class="pl-monto" type="number" step="0.01" placeholder="0.00" value="${monto}"/>
    <button type="button" class="btn btn-del">Eliminar</button>`;
  wrap.querySelector('.btn-del').addEventListener('click',()=>wrap.remove());
  paylines.appendChild(wrap);
}
btnAddLine.addEventListener('click',()=> addPayline());
function setMediosEgreso(){ el('in-medio-eg').innerHTML = MEDIOS_EGRESO.map(m=>`<option>${m}</option>`).join(''); }

function getClientes(){ // de la fecha actual y de buscador no, simple
  const set=new Set(); movimientos.forEach(m=>{ if(m.tipo==='ingreso' && m.cliente){ set.add(m.cliente.toUpperCase()); } });
  return Array.from(set).sort();
}
function showSuggestions(q, box){
  const needle=(q||'').toUpperCase().trim();
  if(!needle){ box.style.display='none'; box.innerHTML=''; return; }
  const items=getClientes().filter(c=>c.includes(needle)).slice(0,15);
  let html = items.map(c=>`<button type="button" data-v="${c}">${c}</button>`).join('');
  if(!items.includes(needle)) html += `<button type="button" data-v="${needle}" data-create="1">Crear “${needle}”</button>`;
  if(!html){ box.style.display='none'; box.innerHTML=''; return; }
  box.innerHTML=html; box.style.display='block';
}

function openModal(tipo,i=null){
  if(ddmm(fechaSeleccionadaDate)!==ddmm(new Date())) return; // sólo hoy
  tipoActual=tipo; editIndex=(typeof i==='number')?i:null;
  el('modal-title').textContent = tipo==='ingreso' ? 'NUEVA VENTA' : 'NUEVO EGRESO';

  inCliente.value=''; inDetalleIng.value=''; selConcepto.value='FACIALES';
  paylines.innerHTML=''; addPayline();
  setMediosEgreso(); el('in-medio-eg').value='EFECTIVO'; montoEg.value=''; inDescEg.value='';

  el('row-paylines').style.display = (tipo==='ingreso')?'grid':'none';
  el('wrap-concepto-select').style.display = (tipo==='ingreso')?'block':'none';
  el('wrap-cliente').style.display = (tipo==='ingreso')?'block':'none';
  el('row-desc-ing').style.display = (tipo==='ingreso')?'grid':'none';
  el('row-egreso').style.display = (tipo==='egreso')?'grid':'none';

  modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
}
function closeModal(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); editIndex=null; sugBox.style.display='none'; }
el('modal-cerrar').addEventListener('click',closeModal);
el('cancelar').addEventListener('click',closeModal);
modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });
window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

inCliente.addEventListener('input', e=> showSuggestions(e.target.value, sugBox));
inCliente.addEventListener('focus', e=> showSuggestions(e.target.value, sugBox));
document.addEventListener('click', e=>{ if(!sugBox.contains(e.target) && e.target!==inCliente){ sugBox.style.display='none'; }});
sugBox.addEventListener('click', e=>{
  const btn=e.target.closest('button'); if(!btn) return;
  inCliente.value = btn.getAttribute('data-v'); sugBox.style.display='none';
});

/* Guardar hacia Sheets */
el('guardar').addEventListener('click', async ()=>{
  try{
    if(tipoActual==='ingreso'){
      const cliente=(inCliente.value||'').trim().toUpperCase();
      const concepto=(selConcepto.value||'').trim().toUpperCase();
      const descripcion=(inDetalleIng.value||'').trim().toUpperCase();
      if(!cliente || !concepto) return;

      const lines=[...document.querySelectorAll('.payline')].map(row=>{
        return { medio:(row.querySelector('.pl-medio').value||'').toUpperCase(),
                 monto:parseFloat(row.querySelector('.pl-monto').value) };
      }).filter(x=>!isNaN(x.monto) && x.monto>0 && MEDIOS_INGRESO.includes(x.medio));
      if(!lines.length) return;

      const rows = lines.map(l=>({
        fecha: ddmm(fechaSeleccionadaDate), cliente, concepto, descripcion,
        monto: Math.abs(l.monto), medio: l.medio, tipo:'ingreso'
      }));
      await apiAddRows(rows);
    }else{
      const concepto=(selConceptoEg.value||'').toUpperCase();
      const medio=(el('in-medio-eg').value||'').toUpperCase();
      const monto=parseFloat(montoEg.value);
      const descripcion=(inDescEg.value||'').trim().toUpperCase();
      if(!concepto || isNaN(monto) || monto<=0 || !MEDIOS_EGRESO.includes(medio)) return;
      const rows=[{
        fecha: ddmm(fechaSeleccionadaDate), cliente:'', concepto, descripcion,
        monto: -Math.abs(monto), medio: medio, tipo:'egreso'
      }];
      await apiAddRows(rows);
    }
    await syncFromSheet(); render(); actualizarArqueoVista(); closeModal();
  }catch(ex){
    alert('Error guardando: '+ex.message);
  }
});

/* ===== Tabla del día ===== */
const tbody=el('tbody'); let visibleIndexMap=[];
function render(){
  tbody.innerHTML=''; visibleIndexMap=[];
  const ddmSel=ddmm(fechaSeleccionadaDate);
  const data=movimientos.map((m,i)=>({...m,__idx:i})).filter(m=>m.fecha===ddmSel);
  data.forEach(m=>{
    visibleIndexMap.push(m.__idx);
    const desc = (m.descripcion && m.descripcion.trim()) ? m.descripcion : '';
    const tr=document.createElement('tr'); tr.className=(m.tipo==='ingreso')?'row-income':'row-expense';
    tr.innerHTML=`
      <td class="drag-handle">≡</td>
      <td>${m.fecha}</td>
      <td>${m.cliente||''}</td>
      <td>${m.concepto}</td>
      <td>${desc}</td>
      <td>${m.monto<0?'- ':''}$${Math.abs(m.monto).toFixed(2)}</td>
      <td>${m.medio}</td>
      <td class="actions-td">
        <div class="menu-wrap">
          <button class="menu-trigger" aria-label="Acciones" data-idx="${m.__idx}">⋯</button>
          <div class="menu" id="menu-${m.__idx}">
            <button class="danger" data-act="delete" data-idx="${m.__idx}" disabled>Eliminar</button>
          </div>
        </div>
      </td>`;
    tbody.appendChild(tr);
  });

  Sortable.create(tbody,{handle:'.drag-handle',animation:140});
}

function closeAllMenus(){ document.querySelectorAll('.menu.show').forEach(m=>m.classList.remove('show')); }
document.addEventListener('click', e=>{
  const trigger=e.target.closest('.menu-trigger');
  if(trigger){ const idx=trigger.dataset.idx; const menu=el('menu-'+idx);
    const isOpen=menu.classList.contains('show'); closeAllMenus(); if(!isOpen) menu.classList.add('show'); return; }
  if(!e.target.closest('.menu-wrap')) closeAllMenus();
});

/* ===== Arqueo ===== */
function esperadoEfectivoDia(){ const ddm=ddmm(fechaSeleccionadaDate);
  return movimientos.reduce((a,m)=> a + ((m.fecha===ddm && m.medio==='EFECTIVO')? m.monto:0), 0); }

function renderListasEfectivo(){
  const ddm=ddmm(fechaSeleccionadaDate), ulIng=el('lista-ing-efectivo'), ulEgr=el('lista-egr-efectivo');
  ulIng.innerHTML=''; ulEgr.innerHTML=''; let sumIng=0, sumEgr=0;
  movimientos.forEach(m=>{
    if(m.fecha!==ddm || m.medio!=='EFECTIVO') return;
    if(m.tipo==='ingreso'){
      const li=document.createElement('li'); li.className='item';
      const label=[m.cliente||'SIN NOMBRE',m.concepto||'',m.descripcion||''].filter(Boolean).join(' · ');
      li.innerHTML=`<span class="concepto">${label}</span><span class="monto">${money(m.monto)}</span>`;
      ulIng.appendChild(li); sumIng+=m.monto;
    }else{
      const li=document.createElement('li'); li.className='item';
      const labelDesc = m.descripcion ? (m.descripcion+' · ') : '';
      li.innerHTML = `<span class="concepto">${labelDesc}${m.concepto}</span><span class="monto">${money(-Math.abs(m.monto))}</span>`;
      ulEgr.appendChild(li); sumEgr+=Math.abs(m.monto);
    }
  });
  el('sum-ing-efectivo').textContent=money(sumIng);
  el('sum-egr-efectivo').textContent=money(-sumEgr);
}
function actualizarEsperado(){ el('esperado').textContent=money(esperadoEfectivoDia()); }
function actualizarArqueoVista(){ actualizarEsperado(); renderListasEfectivo(); }

/* ===== Buscador (Sheets) ===== */
const busqInput=el('busq-cliente'), busqWrap=el('busq-wrap'), busqTBody=el('busq-tbody'), sugBusq=el('sug-busq');
function clearBuscadorUI(){ busqWrap.style.display='none'; busqTBody.innerHTML=''; sugBusq.style.display='none'; sugBusq.innerHTML=''; }
function showSuggestionsBusq(q){
  const needle=(q||'').toUpperCase().trim();
  if(!needle){ clearBuscadorUI(); return; }
  // sugerencias rápidas desde los movimientos cargados del día
  const items=[...new Set(movimientos.filter(m=>m.cliente).map(m=>m.cliente.toUpperCase()))]
    .filter(c=>c.includes(needle)).sort().slice(0,15);
  if(!items.length){ sugBusq.style.display='none'; sugBusq.innerHTML=''; return; }
  sugBusq.innerHTML = items.map(c=>`<button type="button" data-v="${c}">${c}</button>`).join('');
  sugBusq.style.display='block';
}
busqInput.addEventListener('input', e=> showSuggestionsBusq(e.target.value));
busqInput.addEventListener('focus', e=> showSuggestionsBusq(e.target.value));
el('busq-limpiar').addEventListener('click',()=>{ busqInput.value=''; clearBuscadorUI(); busqInput.focus(); });
sugBusq.addEventListener('click', async e=>{
  const btn=e.target.closest('button'); if(!btn) return; const selected=btn.getAttribute('data-v');
  busqInput.value=selected; sugBusq.style.display='none';
  const data = await apiSearchCliente(selected);
  busqTBody.innerHTML='';
  data.forEach(m=>{
    const tr=document.createElement('tr'); tr.innerHTML=`
      <td>${m.fecha}</td><td>${m.cliente||''}</td><td>${m.concepto||''}</td>
      <td>${m.descripcion||''}</td><td style="text-align:right">${money(m.monto||0)}</td><td>${m.medio||''}</td>`;
    busqTBody.appendChild(tr);
  });
  busqWrap.style.display = data.length ? 'block':'none';
});
document.addEventListener('click', e=>{ if(!sugBusq.contains(e.target) && e.target!==busqInput){ sugBusq.style.display='none'; }});
</script>

<!-- BOTÓN DE PRUEBA DE CONEXIÓN -->
<div style="position:fixed;left:18px;bottom:18px;z-index:20">
  <button id="btn-test-api" class="btn btn-primary" style="background:#2f4753;color:#fff;padding:12px 18px;border-radius:12px;font-weight:800">
    🔄 Probar conexión
  </button>
</div>

<script>
document.getElementById('btn-test-api').addEventListener('click', async ()=>{
  try {
    const testUrl = `${API_URL}?action=list&fecha=01/01`; // prueba simple
    const res = await fetch(testUrl, {method:'GET'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    if(data.ok){
      alert('✅ Conexión exitosa con Google Sheets');
    }else{
      alert('⚠️ Error en respuesta del servidor: '+(data.error||''));
    }
  } catch (err) {
    alert('❌ No se pudo conectar al Apps Script.\n\nVerificá que:\n1. La URL del API sea correcta.\n2. Está publicado como “Cualquiera con el enlace”.\n3. No tengas bloqueos CORS.');
  }
});
</script>


</body>
</html>
